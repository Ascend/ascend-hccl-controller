component: hccl-controller
product: MindXDL
systemEnv:
  - workspace
  - processor

compile:
  input:
    envVariables:
      GO111MODULE: "on"
      GONOSUMDB: "*"
      GOPROXY: "http://mirrors.tools.huawei.com/goproxy,direct"
      CGO_ENABLED: "1"
      CGO_CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CGO_CPPFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
    files:
      include:
        - sed:
            option: "-i"
            srcstr: "s/hccl-controller:.*/hccl-controller:${hccl_controller}/"
            curfile: "{{ systemEnv.workspace }}/hccl-controller/build/hccl-controller.yaml"
      exclude:
        - remove:
            - "{{ systemEnv.workspace }}/output/hccl-controller"
  process:
    language: go
    compilePath: "{{ systemEnv.workspace }}/hccl-controller"
    parameters: [
    ["mod", "mod"],
    ["buildmode", "pie"],
    ["ldflags", "-s -extldflags=-Wl,-z,now  -X main.BuildName=hccl-controller  -X main.BuildVersion=${hccl_controller}"],
    ["o", "{{ systemEnv.workspace }}/{{ component}}/output/hccl-controller/hccl-controller"],
    ['trimpath',""],
    ]

  output:
    files:
      include:
        - copy:
            src: ['{{ systemEnv.workspace }}/hccl-controller/build/hccl-controller.yaml']
            des: "{{ systemEnv.workspace }}/{{ component}}/output/hccl-controller/hccl-controller-${hccl_controller}.yaml"
            rename: True
        - copy:
            src: ['{{ systemEnv.workspace }}/hccl-controller/build/Dockerfile']
            des: "{{ systemEnv.workspace }}/{{ component}}/output/hccl-controller/"
        - mode:
            src: ["{{ systemEnv.workspace }}/{{ component}}/output/hccl-controller/*"]
            mode: "400"
        - mode:
            src: [ "{{ systemEnv.workspace }}/{{ component}}/output/hccl-controller/hccl-controller" ]
            mode: "500"
        - makeArchive:
            - src: "{{ systemEnv.workspace }}/{{ component}}/output/hccl-controller"
              des: "{{ systemEnv.workspace }}/{{ component}}/output/Ascend-mindxdl-hccl-controller_${pkgversion}_linux-{{ systemEnv.processor }}"
              prefix: zip
              arch: "{{ systemEnv.processor }}"