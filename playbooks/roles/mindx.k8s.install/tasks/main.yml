- name: message
  debug:
    msg: "******************************start install k8s******************************"

- name: set hostname
  ansible.builtin.hostname:
    name: "{{set_hostname}}"
    use: systemd
  when: set_hostname is defined

- name: set bridge-nf-call-iptables 1
  shell: echo 1 > /proc/sys/net/bridge/bridge-nf-call-iptables
  when:
    - OS_ID == 'centos'
    - OS_VERSION_ID == '7'

- name: disable swap
  shell: swapoff -a

- name: set swap in fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    state: absent
    regexp: '.*?swap.*?'

- name: set route in rc.local
  ansible.builtin.lineinfile:
    path: /etc/rc.local
    line: ip route add 10.96.0.0/16 dev {{ kube_interface }}
    state: present
  when:
    - OS_ID == 'centos'
    - OS_VERSION_ID == '7'
    - kube_interface is defined

- name: set route
  shell: |
    ip route del 10.96.0.0/16 dev {{ kube_interface }}
    ip route add 10.96.0.0/16 dev {{ kube_interface }}
  when:
    - OS_ID == 'centos'
    - OS_VERSION_ID == '7'
    - kube_interface is defined

- name: create /etc/resolv.conf
  file:
    path: /etc/resolv.conf
    state: touch
    mode: '0640'

- name: install sys for ubuntu
  shell: dpkg --force-all -i {{ sys_dir }}/*.deb
  environment:
    DEBIAN_FRONTEND: noninteractive
    DEBIAN_PRIORITY: critical
  when: OS_ID == 'ubuntu'

- name: install sys for not ubuntu
  shell: rpm -ivh --force --nodeps --replacepkgs {{ sys_dir }}/*.rpm
  when: OS_ID != 'ubuntu'

- include_tasks: common.yml

- name: "restart kubelet"
  systemd:
    name: "kubelet"
    enabled: true
    state: restarted
