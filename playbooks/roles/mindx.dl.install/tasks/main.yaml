- name: message
  debug:
    msg: "**********start install MindX DL********************"

- name: check namespace
  shell: "kubectl get namespace | awk '$1 ~ /^{{ item }}$/ {print $1}'"
  environment:
    http_proxy: ""
    https_proxy: ""
    HTTP_PROXY: ""
    HTTPS_PROXY: ""
  register: namespace_result
  changed_when: false
  loop:
    - edge-app

- name: create namespace
  shell: "kubectl create namespace {{ item.item }}"
  environment:
    http_proxy: ""
    https_proxy: ""
    HTTP_PROXY: ""
    HTTPS_PROXY: ""
  when: item.stdout == ""
  loop: "{{ namespace_result.results }}"

- name: create image-pull-secret
  shell: |
    kubectl delete secret --namespace={{ item }} image-pull-secret
    kubectl create secret docker-registry image-pull-secret \
    --namespace={{ item }} \
    --docker-server={{ HARBOR_IP }}:{{ HARBOR_HTTPS_PORT }} --docker-username=admin --docker-password={{ HARBOR_PASSWORD }}
  environment:
    http_proxy: ""
    https_proxy: ""
    HTTP_PROXY: ""
    HTTPS_PROXY: ""
  loop:
    - mindx-dl

- name: copy dlinstall script
  copy:
    src: "{{role_path}}/files/dlinstall"
    dest: /usr/bin/
    mode: 0700

- name: install MindX DL
  shell: "/usr/bin/dlinstall --harbor-ip {{ HARBOR_IP }} --harbor-port {{ HARBOR_HTTPS_PORT }} {{ item }}"
  ignore_errors: true
  when: "ansible_architecture in item"
  with_fileglob:
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-cluster-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-apigw*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-user-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-data-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-dataset-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-edge-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-image-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-label-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-model-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-task-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-train-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-alarm-manager*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-hccl-controller*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-volcano*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-npu-exporter*.zip"
    - "{{ resource_dir }}/mindxdl/Ascend-mindxdl-device-plugin*.zip"
